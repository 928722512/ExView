ExView.Plugins({
	info: {
		name: "E绅士漫画",
		version: "2.1",
		icon:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAWklEQVQ4jWP8//8/AyWAiSLdDAwMLAwMDAzp7EIYzpj58x0jjA2Th4kh86njAmy2EgsodgF1vYAcOOgBhyxPOxcg24YtQNGjkSouoE0gMjAQnyYodgHjgOdGAGwOKyVznIrZAAAAAElFTkSuQmCC",
		author:"光腚菊",
		db: "exhentai",
		apihost: "https://exhentai.org/",
		//"http://exhentai.org/","http://cc.xwind.ml/ehentai/"
		pagetitle: ["<br>", "收藏", "首页", "类型", "下载"],
		download: true,
		lazyload: true,
		setting: true,
		nativeres: true,
		typebox: false,
		cachepath: "ExView/Cache/ExHentai/Cache",
		covercachepath: "ExView/Cache/ExHentai/CoverCache",
		clearcache: true,
		theme: "black",
		cachetime: 3600,
		requestcookie: "" 
		,
		cdn: "" //"http://127.0.0.1/proxy.php?"
	},
	set: function(args) {
		args = args || {};
		setSettingPageExtra([
		{
			name:"typebox",
			title:"类型方块界面",
			type:"checkbox"
		},{
			name:"clearcache",
			title:"自动清除页面缓存",
			type:"checkbox"
		},
		{
			name:"nativeres",
			title:"使用本地请求",
			type:"checkbox"
		},
		{
			name:"requestcookie",
			title:"网络请求Cookie",
			resizable:true,
			type:"textarea"
		}
		{
			value:'<li><div class="col-50"><a href="#" class="button button-raised open-login-screen">登录E绅士</a></div></li>',
			type:'html'
		}
		]);	
		//ExView.modules.settingpage.extra = '<li><div class="item-content"><div class="item-media"><i class="icon icon-form-toggle"></i></div><div class="item-inner"><div class="item-title label">类型方块界面</div><div class="item-input"><label class="label-switch"><input name="typebox"  type="checkbox"/><div class="checkbox"></div></label></div></div></div></li><li><div class="item-content"><div class="item-media"><i class="icon icon-form-toggle"></i></div><div class="item-inner"><div class="item-title label">自动清除页面缓存</div><div class="item-input"><label class="label-switch"><input name="clearcache"  type="checkbox"/><div class="checkbox"></div></label></div></div></div></li><li><div class="item-content"><div class="item-media"><i class="icon icon-form-toggle"></i></div><div class="item-inner"><div class="item-title label">使用本地请求</div><div class="item-input"><label class="label-switch"><input name="nativeres"  type="checkbox"/><div class="checkbox"></div></label></div></div></div></li><li class="align-top"><div class="item-content"><div class="item-media"><i class="icon icon-form-comment"></i></div><div class="item-inner"><div class="item-title floating-label">网络请求Cookie</div><div class="item-input"><textarea class="resizable" name="requestcookie"></textarea></div></div></div></li><li><div class="col-50"><a href="#" class="button button-raised open-login-screen">登录E绅士</a></div></li>';
		//ExView.modules.settingpage.buttons='<a href="#" class="settingpage back link" onclick="ExView.modules.settingpage.reset();">默认</a><a href="#" class="settingpage back link" onclick="ExView.modules.settingpage.save();typerulefind();">保存</a>';
		setCommonPageToolbar({
			photoclass:false
		});
		//ExView.modules.commentpage.toolbar = '<div class="toolbar messagebar" style="background-color:white"><div class="toolbar-inner"><!--a href="#"class="link icon-only"><i class="icon icon-camera"></i></a--><textarea class="commentpage-textarea" placeholder="Message"></textarea><a href="#"class="link send-message" >发送</a></div></div>';
		setCommonPageButtons({
			webpage:false
		});
		//ExView.modules.commentpage.buttons = '<a href="#" class="link" onclick="ExView.workers.comment.loader(ExView.modules.commentpage.tmp.flag);"><i class="icon icon-refresh"></i></a>';



	},
	unset: function(args) {
		args = args || {};
		//ExView.modules.settingpage.extra = '';
		//ExView.modules.commentpage.toolbar = '';
		//ExView.modules.commentpage.buttons = '';
		setloginscreen(false);
		//ExView.modules.settingpage.buttons = '';
	},
	init: function(args) {
		plugfns().initloginscreen({plugin:mySession.nowplugin});
		ExView.workers.fav.listloader({
			callback: function() {



				if (pluginfo(args.plugin).requestcookie) {
					pluginfo(args.plugin,1).cacheheader={"Cookie": pluginfo(args.plugin).requestcookie};
					mySession.nowpluginfo.cacheheader={"Cookie": pluginfo(args.plugin).requestcookie};
					ExView.workers.index.loader();
					ExView.workers.type.loader()
				} else {
					$$("#card-page").html('<div align="center" class="list-block"><img src="http://exhentai.org/" onerror="this.src=\'img/nopic.png\';"/><br>悲伤的熊猫</div>');
					ExView.workers.type.loader()
					slidetopage(1);
					ExView.fw.alert("请设置网络请求Cookie,否则会无法使用！", "ExView", function() {
						ExView.fw.loginScreen();

/*
				createContentPage(settingpage.title,settingpage.content,settingpage.id,settingpage.buttons,settingpage.callback);
				$$("#"+settingpage.id).find('.ks-color-theme').click(function () {
					$$("#setting-theme").val($$(this).attr('data-theme')||"blue");
					settheme($$(this).attr('data-theme')||"blue");
				});
				settingpage.set();*/

					});
				}









			}
		})
	},
	flags: {
		indexflag: {
			loader: function(args) {
				if (!args.front && !args.page) setnowlistname("首页", "", plugfns(args.plugin).typelistext["index"]["imgurl"]);
				return {
					url: pluginfo(args.plugin).apihost + "?page=" + (parseInt(args.page || 1) - 1),
					timeout: 120,
					nativerequest: pluginfo(args.plugin).nativeres,
					header: {
						"Cookie": pluginfo(args.plugin).requestcookie
					},
					successfn: function(result, header) {
						ExView.workers.index.countfinder(obj_contact(args, {
							result: result,
							header: header
						}));
						args.successfn && args.successfn({
							result: result,
							header: header
						})
					},
					errorfn: function() {
						if (!args.page) {
							setnowlistname("首页", "", plugfns(args.plugin).typelistext["index"]["imgurl"])
						}
						ExView.fw.hidePreloader();
						mySession.isloading = 0;
						ExView.fw.alert("网络错误！", "ExView")
					},
					canclefn: function() {
						if (!args.page) {
							setnowlistname("首页", "", plugfns(args.plugin).typelistext["index"]["imgurl"])
						}
					},
					showinfo: {
						text: '正在加载...' + ((args.page > 1) ? '<br>第' + args.page + '页' : ''),
						name:'首页',
						title: mySession.nowlistname,
						img: mySession.nowlistimg
					}
				}
			},
			finder: function(args) {
				return {
					reg: plugfns(args.plugin).pagerule,
					str: args.result,
					find: plugfns(args.plugin).pagefind,
					successfn: function(rr) {
						console.log(JSON.stringify(rr));
						if (rr) {
							plugfns(args.plugin).pagedeal(rr)
						} else {
							addcardlist('<div align="center" class="list-block"><img src="img/logo.png"/><br>没有内容</div>', 2)
						}
					},
					errorfn: function() {
						if (!args.page) {
							setnowlistname("首页", "", plugfns(args.plugin).typelistext["index"]["imgurl"])
						}
						ExView.fw.hidePreloader();
						mySession.isloading = 0;
						ExView.fw.alert("网络错误！", "ExView")
					}
				}
			},
			countloader: function(args) {
				return false
			},
			countfinder: function(args) {
				return {
					reg: plugfns(args.plugin).pagecountrule,
					str: args.result,
					find: plugfns(args.plugin).pagecountfind,
					successfn: function(rr) {
						console.log(JSON.stringify(rr));
						if (rr) {
							rr = rr.split("{{separator}}");
							mySession.nowlistpages = Math.ceil(parseInt(rr[2].replace(/\,/g, "")) / 25) + "|" + "首页" + "|" + "index";
							//mySession.nowlistpages = rr[0]+"|"+"首页"+"|"+"index";
							mySession.nowlistpage = 1;
							console.log(mySession.nowlistpages);
						} else {
							mySession.nowlistpages = "-1" + "|" + "首页" + "|" + "index";
							mySession.nowlistpage = 1;
							console.log(mySession.nowlistpages);
						}
					}
				}
			}
		},
		typeflag: {
			loader: function(args) {
				return {
					successfn: function() {
						ExView.workers.type.finder()
					}
				}
			},
			finder: function(args) {

				return {
					successfn: function(rr) {
						if (pluginfo(args.plugin).typebox) {
							var typestring = '<table border="1" style="position: absolute;border-collapse: collapse;width: 100%;height:100%;border:1px solid #000000"><tbody><tr><td style="overflow: hidden;width: 33%;"><div onclick="setnowlistname(\'' + plugfns(args.plugin).typelistext["index"]["title"] + '\',\'\',\'' + plugfns(args.plugin).typelistext["index"]["imgurl"] + '\');ExView.workers.index.loader({turnpage:1,front:1})" style="background-image:url(' + plugfns(args.plugin).typelistext["index"]["imgurl"] + ');width:100%;height:100%;background-repeat:no-repeat;background-size:cover;text-align:center;background-size:100%100%;"></div><div style="font-size:16px;text-align:center;background-color: black;margin-top:-24px;opacity: 0.8;position: relative;color: white;">' + plugfns(args.plugin).typelistext["index"]["title"] + '</div></td><td  style="overflow: hidden;width: 33%;"><div onclick="setnowlistname(\'' + plugfns(args.plugin).typelistext["topfive"]["title"] + '\',\'&f_doujinshi=1&f_manga=1&f_artistcg=1&f_gamecg=1&f_western=1&f_non-h=1&f_imageset=1&f_cosplay=1&f_asianporn=1&f_misc=1&f_sname=on&f_stags=on&f_sdesc=on&f_storr=on&f_sdt2=on&f_sh=on&f_sr=on&f_srdd=5\',\'' + plugfns(args.plugin).typelistext["topfive"]["imgurl"] + '\');ExView.workers.list.loader({keyword:\'advsearch\',turnpage:1});" style="background-image:url(' + plugfns(args.plugin).typelistext["topfive"]["imgurl"] + ');width:100%;height:100%;background-repeat:no-repeat;background-size:cover;text-align:center;background-size:100%100%;"></div><div style="font-size:16px;text-align:center;background-color: black;margin-top:-24px;opacity: 0.8;position: relative;color: white;">' + plugfns(args.plugin).typelistext["topfive"]["title"] + '</div></td>';
							var typeint = 3;
							for (var key in plugfns(args.plugin).typelist) {
								typestring += (typeint == 1 ? "<tr>" : "") + '<td style="overflow: hidden;width: 33%;"><div onclick="setnowlistname(\'' + plugfns(args.plugin).typelist[key]["title"] + '\',\'\',\'' + plugfns(args.plugin).typelist[key]["imgurl"] + '\');ExView.workers.list.loader({keyword:\'' + key + '\',turnpage:1})" style="background-image:url(' + plugfns(args.plugin).typelist[key]["imgurl"] + ');width:100%;height:100%;background-repeat:no-repeat;background-size:cover;text-align:center;background-size:100%100%;"></div><div style="font-size:16px;text-align:center;background-color: black;margin-top:-24px;opacity: 0.8;position: relative;color: white;">' + plugfns(args.plugin).typelist[key]["title"] + '</div></td>' + (typeint == 3 ? "</tr>" : "");
								if (typeint == 3) {
									typeint = 1
								} else {
									typeint++
								}
							}
							typestring += '</tbody></table>';
							addtypelist(typestring, 2);
							try {
								clearInterval(mySession.lazyload.typelistlazyloadser)
							} catch (e) {}
							$$("#typelist").onscroll = ""
						} else {
							addtypelist('<ul></ul>', 2);
							addtypelist({
								tid: '',
								listbg:true,
								listfn: 'ExView.workers.index.loader({turnpage:1,front:1})',
								title: plugfns(args.plugin).typelistext["index"]["title"],
								img: plugfns(args.plugin).typelistext["index"]["imgurl"],
								content: plugfns(args.plugin).typelistext["index"]["title"]
							});
							addtypelist({
								tid: 'advsearch',
								listbg:true,
								listflag: '&f_doujinshi=1&f_manga=1&f_artistcg=1&f_gamecg=1&f_western=1&f_non-h=1&f_imageset=1&f_cosplay=1&f_asianporn=1&f_misc=1&f_sname=on&f_stags=on&f_sdesc=on&f_storr=on&f_sdt2=on&f_sh=on&f_sr=on&f_srdd=5',
								title: plugfns(args.plugin).typelistext["topfive"]["title"],
								img: plugfns(args.plugin).typelistext["topfive"]["imgurl"],
								content: plugfns(args.plugin).typelistext["topfive"]["title"]
							});
							for (var key in plugfns(args.plugin).typelist) {
								addtypelist({
									tid: key,
									listbg:true,
									title: plugfns(args.plugin).typelist[key]["title"],
									img: plugfns(args.plugin).typelist[key]["imgurl"],
									content: plugfns(args.plugin).typelist[key]["title"]
								})
							}
						}
					}
				}
			},
		},
		listflag: {
			loader: function(args) {
				return {
					url: pluginfo(args.plugin).apihost + "?f_" + args.keyword + "=1&f_apply=Apply+Filter" + "&page=" + (parseInt(args.page || 1) - 1) + mySession.nowlistflag,
					method: "GET",
					timeout: 120,
					nativerequest: pluginfo(args.plugin).nativeres,
					header: {
						"Cookie": pluginfo(args.plugin).requestcookie
					},
					successfn: function(result, header) {
						if (result) {
							ExView.workers.list.countfinder(obj_contact(args, {
								result: result,
								header: header
							}));
							args.successfn && args.successfn({
								result: result,
								header: header
							})
						} else {
							ExView.fw.hidePreloader();
							mySession.isloading = 0;
							ExView.fw.alert('【' + mySession.nowlistname + '】<br>获取失败！', "ExView")
						}
					},
					showinfo: {
						text: '正在加载...' + ((args.page > 1) ? '<br>第' + args.page + '页' : ''),
						name:'【' + mySession.nowlistname + '】',
						title: mySession.nowlistname,
						img: mySession.nowlistimg
					}
				}
			},
			finder: function(args) {

				return {
					reg: plugfns(args.plugin).pagerule,
					str: args.result,
					find: plugfns(args.plugin).pagefind,
					successfn: function(rr) {
						if (rr) {
							plugfns(args.plugin).pagedeal(rr)
						} else {
							addcardlist('<div align="center" class="list-block"><img src="img/logo.png"/><br>没有内容</div>', 1)
						}
					}
				}
			},
			countloader: function(args) {
				return false
			},
			countfinder: function(args) {

				return {
					reg: plugfns(args.plugin).pagecountrule,
					str: args.result,
					find: plugfns(args.plugin).pagecountfind,
					successfn: function(rr) {
						if (rr) {
							rr = rr.split("{{separator}}");
							mySession.nowlistpages = Math.ceil(parseInt(rr[2].replace(/\,/g, "")) / 25) + "|" + args.keyword + "|" + "list";
							mySession.nowlistpage = 1;
							console.log(mySession.nowlistpages)
						} else {
							mySession.nowlistpages = "-1" + "|" + args.keyword + "|" + "list";
							mySession.nowlistpage = 1;
							console.log(mySession.nowlistpages)
						}
						return true
					}
				}
			}
		},
		searchflag: {
			loader: function(args) {
				return {
					url: pluginfo(args.plugin).apihost + "?f_doujinshi=1&f_manga=1&f_artistcg=1&f_gamecg=1&f_western=1&f_non-h=1&f_imageset=1&f_cosplay=1&f_asianporn=1&f_misc=1&f_search=" + (args.keyword) + "&f_apply=Apply+Filter" + "&page=" + (parseInt(args.page || 1) - 1),
					method: "GET",
					timeout: 120,
					nativerequest: pluginfo(args.plugin).nativeres,
					header: {
						"Cookie": pluginfo(args.plugin).requestcookie
					},
					successfn: function(result, header) {
						if (result) {
							if (!args.multsearch) {
								ExView.workers.search.countfinder(obj_contact(args, {
									result: result,
									header: header
								}));
								setnowlistname("搜索【" + args.keyword + "】")
							}
							args.successfn && args.successfn({
								result: result,
								header: header
							})
						} else {
							if (!args.multsearch) {
								ExView.fw.hidePreloader();
								mySession.isloading = 0;
								ExView.fw.alert('【' + args.keyword + '】<br>获取搜索结果失败！', "ExView")
							} else {
								args.multsearch();
							}
						}
					},
					showinfo: {
						text: '正在搜索...' + ((args.page > 1) ? '<br>第' + args.page + '页' : ''),
						name:'【' + args.keyword + '】',
						title: "搜索"
					}
				}
			},
			finder: function(args) {

				return {
					reg: plugfns(args.plugin).pagerule,
					str: args.result,
					find: plugfns(args.plugin).pagefind,
					successfn: function(rr, arr, i) {
						console.log(rr);
						if (rr) {
							plugfns(args.plugin).pagedeal(rr, args)
						} else {
							if (!args.multsearch) {
								/*mySession.nowlistpages = "-1" + "|" + args.keyword + "|" + "search";
								mySession.nowlistpage = 1;
								console.log(mySession.nowlistpages);*/
								addcardlist('<div align="center" class="list-block"><img src="img/logo.png"/><br>没有内容</div>', 1)
							} else {
								args.multsearch();
							}
						}
					}
				}
			},
			countloader: function(args) {
				return false
			},
			countfinder: function(args) {

				return {
					reg: plugfns(args.plugin).pagecountrule,
					str: args.result,
					find: plugfns(args.plugin).pagecountfind,
					successfn: function(rr) {
						if (rr) {
							rr = rr.split("{{separator}}");
							mySession.nowlistpages = Math.ceil(parseInt(rr[2].replace(/\,/g, "")) / 25) + "|" + args.keyword + "|" + "search";
							mySession.nowlistpage = 1;
							console.log(mySession.nowlistpages)
						} else {
							mySession.nowlistpages = "-1" + "|" + args.keyword + "|" + "search";
							mySession.nowlistpage = 1;
							console.log(mySession.nowlistpages)
						}
						return true
					}
				}
			}
		},
		contentflag: {
			loader: function(args) {
				return {
					url: pluginfo(args.plugin).apihost + "g/" + args.pid.replace(/\_/g, "/") + "/",
					method: "GET",
					timeout: 120,
					nativerequest: pluginfo(args.plugin).nativeres,
					header: {
						"Cookie": pluginfo(args.plugin).requestcookie
					},
					successfn: function(result, header) {
/*mySession.contentinfo = {
							pid: args.pid
						};*/
						if (result) {
							args.successfn && args.successfn({
								result: result,
								header: header
							})
						} else {
							if (!args.checkupdate) {
								ExView.fw.hidePreloader();
								mySession.isloading = 0;
								ExView.fw.alert("内容页获取失败！", "ExView");
							}
						}
					},
					showinfo: {
						text: '正在加载内容页...',
						title: "内容页",
						name:getlistname(args.pid),
						img: getlistimg(args.pid)
					}
				}
			},
			finder: function(args) {
				return {
					reg: plugfns(args.plugin).pagecountrule,
					str: args.result,
					find: plugfns(args.plugin).pagecountfind,
					successfn: function(rr) {


						if (rr) {
							rr = rr.split("{{separator}}");
							var pid = args.pid;
							var arr = Math.ceil(parseInt(rr[2].replace(/\,/g, "")) / 40);
if(!args.checkupdate){									
							var result = new Array();
							for (var i = 0; i < arr; i++) {


								result[i] = additemlist({
									id: i,
									newest: (args.newest && i == 0),
									pid: pid,
									cid: (i + 1),
									title: "第" + (i + 1) + "话",
									count: arr,
									reverse: 0
								});

							}
							console.log(result);

							return result;
}else{
	return {pid:pid,cid:arr,title:"第" + arr + "话"};
}



						} else {
							if (!args.checkupdate) {
								ExView.fw.hidePreloader();
								mySession.isloading = 0;
								ExView.fw.alert("内容页获取失败！", "ExView")
							}
						}

					},
					afterfn: function() {
						if (!args.checkupdate) {
							ExView.workers.content.infoloader(args)
						}
					}
				}
			},
			infoloader: function(args) {
				return {
					successfn: function() {
						args.successfn && args.successfn({
							result: args.result,
							header: args.header
						});
					},
					showinfo: {
						text: '正在加载内容页...',
						title: "内容页",
						name:getlistname(args.pid),
						img: getlistimg(args.pid)
					}
				}
			},
			infofinder: function(args) {
				console.log((args));
				return {
					reg: /<div\s*id="gd1"><img\s*src="(.*?)"\s*alt=""\s*\/><\/div><\/div><div\s*id="gd2"><h1\s*id="gn">(.*?)<\/h1>/g,
					str: args.result,
					find: "$1{{separator}}$2",
					successfn: function(rr, arr, i, result) {

						console.log(rr);
						rr = rr.split("{{separator}}");
						var pid = args.pid;
						args.str = args.result;
						args.name = rr[1];





						//var pagedom = $$(".card_" + pid).find(".card-header");
						//var img = rr[0];
					
						/*if (!$$(pagedom).attr("data-now-src")) {
							ExView.modules.getimgcache(img, function(name, fullPath, entry) {
								var savecachename = ExView.tools.md5.hex_md5(img);
								$$("#listpic").find("img").attr("data-src", img);
								$$("#listpic").find("img").attr("src", fullPath);
								myContent["pic"] = fullPath;
							}, null, null, pluginfo.covercachepath);
						} else {
							img = $$(pagedom).attr("data-now-src");
						}*/









						myContent.preview = new Array();
						var more = '';
						var tag =gettags(args.result,/\/tag\/(.*?)\"/g,"$1")
						/*var tags = args.result.match(/\/tag\/(.*?)\"/g);
						var tag = "";
						if (tags) {
							tags = tags.map(function(item) {
								return decodeURIComponent(item.replace(/\/tag\/(.*?)\"/g, "$1").replace(/\+/, " "))
							});
							for (var key in tags) {
								tag += gettag(tags[key])
							}
						}*/
						//console.log(tags);
						var img = ((rr[0].substr(0, 2) == "//") ? ("http:" + rr[0]) : rr[0]);
						var piccount=getstr(/of\s*([\d,\,]+)\s*images<\/p>/,args.result);
						//if(pluginfo(args.plugin).nativeres){
							img=getimgload(img,args.plugin,{cachepath:pluginfo(args.plugin).covercachepath,cachetime:0});
						//}							
						
						myContent.imgcount = piccount || 0;
						setlistpic({
							name: rr[1],
							img: img,
							added: args.data,
							description: more + "<p>共" + (piccount || 0) + "张图片</p>",
							comment: 1,
							preview: 1,
							tags: gettag(rr[1])+tag
						});
						return true
					}
				}
			}
		},
		parseflag: {
			loader: function(args) {
				return {
					url: pluginfo(args.plugin).apihost + "g/" + args.pid.replace(/\_/g, "/") + "?p=" + (parseInt(args.cid) - 1),
					method: "GET",
					data: "",
					timeout: 120,
					nativerequest: pluginfo(args.plugin).nativeres,
					header: {
						"Cookie": pluginfo(args.plugin).requestcookie
					},
					successfn: function(result, header) {
						args.successfn && args.successfn({
							result: result,
							header: header
						})
					},
					showinfo: {
						text: '正在加载图片信息...',
						title: "图片",
						name:getlistname(args.pid),
						img: getlistimg(args.pid)
					}
				}
			},
			finder: function(args) {
				console.log(args);
				return {
					reg: /<div\s*class="gdtm"\s*style="height:(\d+)px"><div\s*style=".*?height:(\d+)px;\s*background:transparent\s*url\((.*?)\)\s*-(\d+)px\s*0\s*no-repeat"><a\s*href="(.*?)"/g,
					str: args.result,
					find: "$1" + "{{separator}}" + "$2" + "{{separator}}" + "$3" + "{{separator}}" + "$4" + "{{separator}}" + "$5",
					successfn: function(rr, arr, i, result) {
						if (array_count(result)) {
							var source = [];
							//photoscontent.pages=new Array();
							//photoscontent.pagesjson=new Array();				
							//console.log(JSON.stringify(rr));
							//photoscontent.pages.push(rr[2]+"|"+rr[3]+"|"+rr[4]);
							//photoscontent.pagesjson.push("http://about:blank?"+rr[4]);
							source = result.map(function(item) {
								var rr = item.split("{{separator}}");
								return getpageload(rr[4],args.plugin,{cacheheader:{"Cookie": pluginfo(args.plugin).requestcookie}}) ;
							});
							console.log(source);
							if (args.download) {
								chapterpredownload({
									source: source,
									download: args.download,
									plugin: args.plugin
								});
								//chapterpredownload(pagesjson, args.download,args.plugin);
							} else {
								chapterviewer({
									source: source,
									type: "image",
									startindex: (args.startindex || 0),
									lazyload: pluginfo(args.plugin).lazyload,
									zoom: true,
									title: args.title
								});
								//ExView.views.picviewer(pagesjson, (args.startindex ? args.startindex : 0), ((pluginfo(args.plugin).lazyload == true || pluginfo(args.plugin).lazyload == 'on') ? true : false), 'light', 'standalone', true, args.title)
							}
						} else {
							if(!args.download){
								ExView.fw.hidePreloader();
								mySession.isloading = 0;
								ExView.fw.alert("图片信息获取失败！","ExView");						
							}else{
									chapterpredownload({
										error: "解析错误！",
										download: args.download,
										plugin: args.plugin
									});					
							}
						}
						return true
					}
				}
			}
		},
		commentflag: {
			loader: function(args) {
				//alert($$(".commentpage-textarea").val());
				var pid = args.pid;
				ExView.modules.commentpage.tmp.flag = args;
				$$("#commentpage-title").html("评论 - " + args.title);
				var method = ($$(".commentpage-textarea").val() ? "POST" : "GET");
				var data = ($$(".commentpage-textarea").val() ? ("commenttext=" + encodeURIComponent($$(".commentpage-textarea").val()) + "&postcomment=Post+Comment") : "");
				//alert(method);
				//alert(data);
				return {
					url: pluginfo(args.plugin).apihost + "g/" + pid.replace(/\_/g, "/") + "/?hc=1",
					method: method,
					data: data,
					timeout: 120,
					nativerequest: pluginfo(args.plugin).nativeres,
					header: {
						"Cookie": pluginfo(args.plugin).requestcookie,
						"Content-Type": "application/x-www-form-urlencoded"
					},
					successfn: function(result, header) {
						//alert(result);
						args.successfn && args.successfn({
							result: result,
							header: header
						})
					},
					errorfn: function() {
						ExView.fw.hidePreloader();
						mySession.isloading = 0;
					},
					showinfo: data ? {
						text: '正在提交评论...',
						title: '评论',
						name:getlistname(pid),
						img: getlistimg(pid)
					} : {
						text: '正在加载评论...',
						title: '评论',
						name:getlistname(pid),
						img: getlistimg(pid)
					}
				}
			},
			finder: function(args) {
				var pid = args.pid;
				return {
					reg: /<a\s*name="c\d+"><\/a><div\s*class="c1"><div\s*class="c2"><div\s*class="c3">Posted\s*on\s*(.*?)\s*UTC\s*by:\s*&nbsp;\s*<a\s*href=".*?">(.*?)<\/a><\/div><div\s*class="c\d+\s*nosel"(.*?)<div\s*class="c6"\s*id="comment_\d+">(.*?)<\/div><div\s*class="c7"/g,
					str: args.result,
					find: "$1{{separator}}$2{{separator}}$3{{separator}}$4",
					successfn: function(rr) {
						//alert(JSON.stringify(rr));
						console.log(rr);

						if (rr) {
							rr = rr.split("{{separator}}");
							ExView.modules.myMessages.appendMessage({
								text: (rr[3]||"").replace(/href=/g,"xhref="),
								name: (rr[1]||"").replace(/href=/g,"xhref="),
								avatar: "img/logo.png",
								type: (rr[2].indexOf('>Edit</a>') != "-1" ? "sent" : "received"),
								label: "",
								day: rr[0].split(",")[0],
								time: rr[0].split(",")[1]
							}, true);

							$$(".message-avatar")[$$(".message-avatar").length - 1].className = "message-avatar bg-" + getrandomtheme();
							$$($$(".message-avatar")[$$(".message-avatar").length - 1]).html(cutstr(rr[1], 1, ""));
							$$(".message-avatar").attr("style", "text-align: center;line-height: 48px;color: white;");
							$$(".c8").attr("style", "padding-left:56px;white-space: nowrap;");


						}
					},
					errorfn: function() {
						ExView.fw.hidePreloader();
						mySession.isloading = 0;
					},
					afterfn: function() {
/*if(!$$(".messages").html()){
					$$(".messages").html('<div align="center" class="list-block">没有内容</div>');
				}*/
						ExView.fw.hidePreloader();
						mySession.isloading = 0;
						//alert(pid);

						$$(".send-message")[0].onclick = function() {
							//curl({});
							ExView.workers.comment.loader(args);
							//alert($$(".commentpage-textarea").val());
							//myMessages.appendMessage({text:$$(".commentpage-textarea").val(),name:"Gentle",avatar:"https://avatars2.githubusercontent.com/u/4105507?v=3&s=40",type:"received",label:"Fuck YOU!",day:"2016/03/01",time:"14:23"}, true);
							$$(".commentpage-textarea").val("");
						}

					}
				}
			}
		},
		previewflag: {
			loader: function(args) {
				return {
					url: pluginfo(args.plugin).apihost + "g/" + args.pid.replace(/\_/g, "/") + "?p=" + (parseInt(args.page || 1) - 1),
					method: "GET",
					timeout: 120,
					nativerequest: pluginfo(args.plugin).nativeres,
					header: {
						"Cookie": pluginfo.requestcookie
					},
					successfn: function(result, header) {
/*mySession.contentinfo = {
							pid: args.pid
						};*/
						if (result) {
							args.successfn && args.successfn({
								result: result,
								header: header,
							})
						} else {
							ExView.fw.hidePreloader();
							mySession.isloading = 0;
							ExView.fw.alert("预览信息获取失败！", "ExView");
							myContent.previewloading = 1;
							var t=getTimeNow();
							$$("#previewpage").append('<div class="previewerrorinfo_'+t+'" style="width:100%;text-align:center;"><a class="button button-fill bg-red" href="javascript:void(0);">重试加载第'+args.page+'页</a></div>');	
							$$('.previewerrorinfo_'+t).on("click",function(){
								$$('.previewerrorinfo_'+t).remove();
								ExView.modules.listpreview(args);
							});							
						}
					},
					errorfn:function(){
							ExView.fw.hidePreloader();
							mySession.isloading = 0;
							ExView.fw.alert("预览信息获取失败！", "ExView")						
							myContent.previewloading = 1;
							var t=getTimeNow();
							$$("#previewpage").append('<div class="previewerrorinfo_'+t+'" style="width:100%;text-align:center;"><a class="button button-fill bg-red" href="javascript:void(0);">重试加载第'+args.page+'页</a></div>');	
							$$('.previewerrorinfo_'+t).on("click",function(){
								$$('.previewerrorinfo_'+t).remove();
								ExView.modules.listpreview(args);
							});
					},
					canclefn:function(){
							ExView.fw.hidePreloader();
							mySession.isloading = 0;				
							myContent.previewloading = 1;
							var t=getTimeNow();
							$$("#previewpage").append('<div class="previewerrorinfo_'+t+'" style="width:100%;text-align:center;"><a class="button button-fill bg-red" href="javascript:void(0);">重试加载第'+args.page+'页</a></div>');	
							$$('.previewerrorinfo_'+t).on("click",function(){
								$$('.previewerrorinfo_'+t).remove();
								ExView.modules.listpreview(args);
							});
					},
					showinfo: {
						text: '正在获取预览信息...',
						title: "预览页",
						name:getlistname(args.pid),
						img: getlistimg(args.pid)
					}
				}
			},
			finder: function(args) {
				console.log(args);
				return {
					reg: /<div\s*class="gdtm"\s*style="height:\d+px"><div\s*style="margin:1px\s*auto\s*0;\s*width:(\d+)px;\s*height:(\d+)px;\s*background:transparent\s*url\((.*?)\)\s*([\-,\d]+)px\s*0\s*no-repeat"><a\s*href="(.*?)"/g,
					str: args.result,
					find: "$1" + "{{separator}}" + "$2" + "{{separator}}" + "$3" + "{{separator}}" + "$4" + "{{separator}}" + "$5",
					successfn: function(rr, arr, i, result) {
						if(rr){
							rr = rr.split("{{separator}}");
							var imgurl = ((rr[2].substr(0, 2) == "//") ? ("http:" + rr[2]) : rr[2]);
							var pageurl = (rr[4].substr(0, 1) == "/" ? (pluginfo(args.plugin).apihost.split("//")[0] + "//" + (pluginfo(args.plugin).apihost.split("//")[1].split("/")[0])) + "/" + rr[4].substring(1) : rr[4]);
							myContent.preview["Page_" + (args.page || 1)].push({
								imgurl: imgurl,
								pageurl: pageurl,
								width: rr[0],
								height: rr[1],
								leftoffset: rr[3],
								topoffset: 0
							})							
						}

					},
					beforefn: function() {
						if (myContent.preview["Page_" + (args.page || 1)] === undefined) {
							myContent.preview["Page_" + (args.page || 1)] = new Array()
						}
					}
				}
			},
			more: function(args) {
				return function() {
					if (!myContent.previewloading && parseInt(args.page || 1) < myContent.items.length) {
						myContent.previewloading = 1;
						ExView.modules.listpreview(obj_contact(args, {
							page: parseInt(args.page || 1) + 1,
							callback: function(key) {
								var content = ExView.modules.previewpage.add(key);
								//alert(content);
								if(content){
									$$("#previewpage").append(content);
									$$(".previewpage-content").css("zoom", parseFloat($$(".previewpage-content").css("zoom")));
									myContent.previewloading = 0;
								}
							}
						}));
					}


				}
			}
		},
		pageimgflag: {
			parser:function(args){//[pagedom,pageurl,url,result,loadimgurl]
				return {
					reg: /<img\s*id="img"\s*src="(.*?)"/g,
					str: args.result,
					find: "$1",
					successfn: function(rr) {
						args.loadimgurl(rr);
						var nlcode=getstr(/return\s*nl\('([\d-]+)'\)/,args.result);
						if (nlcode&&args.pagedom) {
							var nlurl = args.pageurl + ((args.pageurl + "").indexOf("?") > -1 ? "&" : "?") + "nl=" + nlcode;
							$$(args.pagedom).attr("data-nl-src", getpageload(nlurl,args.plugin,{cacheheader:{"Cookie": pluginfo(args.plugin).requestcookie}}));
						} else {
							$$(args.pagedom).attr("data-nl-src", args.url);
						}
						
					}
				}				
			}
		},
		updateflag: {
			loader: function(args) {

				return {
					url: pluginfo(args.plugin).apihost + "?page=" + (parseInt(args.page || 1) - 1),
					timeout: 120,
					nativerequest: pluginfo(args.plugin).nativeres,
					header: {
						"Cookie": pluginfo(args.plugin).requestcookie
					},
					successfn: function(result, header) {
						args.successfn && args.successfn({
							result: result,
							header: header
						})
					}
				}
			},
			finder: function(args) {

				return {
					reg: plugfns(args.plugin).pagerule,
					str: args.result,
					find: plugfns(args.plugin).pagefind,
					successfn: function(rr) {
						console.log(JSON.stringify(rr));
						if (rr) {
							plugfns(args.plugin).pagedeal(rr, args)
						}
					}
				}
			}
		},
		hotflag: {
			loader: function(args) {

				return {
					url: pluginfo(args.plugin).apihost + "?f_advsearch=1&f_apply=Apply+Filter" + "&page=" + (parseInt(args.page || 1) - 1) + "&f_doujinshi=1&f_manga=1&f_artistcg=1&f_gamecg=1&f_western=1&f_non-h=1&f_imageset=1&f_cosplay=1&f_asianporn=1&f_misc=1&f_sname=on&f_stags=on&f_sdesc=on&f_storr=on&f_sdt2=on&f_sh=on&f_sr=on&f_srdd=5",
					method: "GET",
					timeout: 120,
					nativerequest: pluginfo(args.plugin).nativeres,
					header: {
						"Cookie": pluginfo(args.plugin).requestcookie
					},
					successfn: function(result, header) {
						args.successfn && args.successfn({
							result: result,
							header: header
						})
					}
				}
			},
			finder: function(args) {

				return {
					reg: plugfns(args.plugin).pagerule,
					str: args.result,
					find: plugfns(args.plugin).pagefind,
					successfn: function(rr) {
						console.log(JSON.stringify(rr));
						if (rr) {
							plugfns(args.plugin).pagedeal(rr, args)
						}
					}
				}
			}
		}
	},
	fns: {
		initloginscreen:function(args){
			args=args||{};
			setloginscreen('<div class="login-screen-title">EXHENTAI</div><form><div class="list-block inputs-list"><ul><li class="item-content"><div class="item-inner"><div class="item-title label">用户名</div><div class="item-input item-input-field"><input type="text" id="login-username" name="username" placeholder="Your Username"></div></div></li><li class="item-content"><div class="item-inner"><div class="item-title label">密码</div><div class="item-input item-input-field"><input id="login-password" type="password" name="password" placeholder="Your Password"></div></div></li></ul></div><div class="content-block"><a href="#" id="login-login" class="button button-big">登录</a><a href="#" id="login-reg" class="button button-big">注册</a><a href="#" id="login-cancle" class="button button-big close-login-screen">取消</a></div><div style="position:absolute;bottom:0;text-align:center;margin:0;padding:0;width:100%"><div class="list-block-label">ExView不提供和传播任何资源，所有资源均来源于互联网！</div></div></form>');
			var loginexhentai = function(user, passwd) {
					ExView.modules.curl({
						url: "https://forums.e-hentai.org/index.php?act=Login&CODE=01",
						method: "POST",
						data: "returntype=8&CookieDate=1&b=d&bt=pone&UserName=" + user + "&PassWord=" + passwd + "&ipb_login_submit=Login%21",
						timeout: 120,
						header: {
							"Content-Type": "application/x-www-form-urlencoded"
						},
						nativerequest: true,
						successfn: function(result, header) {
							//alert(result);
							//alert(JSON.stringify(header["Set-Cookie"]));
							try {
								var headers = header["Set-Cookie"];
								var cookies = "";
								for (var key in headers) {
									cookies += headers[key].split(";")[0] + ";";
								}
								console.log(result);
								console.log(header);
								var user = getstr(/logged in as:((?!<).*?)</i,result);
								ExView.fw.hidePreloader();
								if (!user) {
									ExView.fw.hidePreloader();
									ExView.fw.alert("可能用户名和密码错误，或者尝试过多验证限制，晚点再试！", "登陆失败");
									return false;
								}

								ExView.modules.curl({
									url: mySession.nowpluginfo.apihost,
									method: "GET",
									timeout: 120,
									header: {
										"Cookie": cookies
									},
									nativerequest: true,
									successfn: function(result, header) {
										//alert(result);
										//alert(JSON.stringify(header["Set-Cookie"]));
										var headers = header["Set-Cookie"];
										for (var key in headers) {
											cookies += (headers[key]||"").split(";")[0] + ";";
										}
										ExView.fw.hidePreloader();
										try {
											//alert(cookies);
											if (cookies) {
												var storagename = "f7form-" + pluginfo(args.plugin).db + "_Settings";
												//alert(storagename);
												//alert(localStorage[storagename]);
	/*var pluginfos={};
					try{
						pluginfos=JSON.parse(localStorage[storagename]);
					}catch(e){
						pluginfos={};
					}*/


												pluginfo(args.plugin,1).requestcookie = cookies;
												localStorage[storagename] = JSON.stringify(pluginfo(args.plugin,1));
												ExView.fw.alert("已经成功登陆E绅士！", "登陆成功", function() {
													$$(".login-screen.modal-in").css("display","none");
													mySession.plugins[args.plugin].init(args);
												});
											} else {
												ExView.fw.alert("未知错误！", "登陆失败");
											}
										} catch (e) {

											ExView.fw.alert(e, "登陆失败");
										}


										//alert(cookies);		
									},
									showinfo: {
										text: '正在登陆用户<br>' + user,
										title: "登陆",
										img: pluginfo(args.plugin).apihost + "favicon.ico"
									}
								});
							} catch (e) {
								ExView.fw.alert(e, "登陆失败");
							}
						},
						showinfo: {
							text: "正在登陆E绅士...",
							title: "登陆",
							img: pluginfo(args.plugin).apihost + "favicon.ico"
						}
					});

				}
			$$("#login-reg").on("click", function() {
				window.open("http://forums.e-hentai.org/index.php?act=Reg&CODE=00", "_blank", 'location=no');
			});
			$$("#login-login").on("click", function() {
				if ($$("#login-username").val() && $$("#login-password").val()) {
					loginexhentai($$("#login-username").val(), $$("#login-password").val());
				} else {
					ExView.fw.alert("用户名和密码不能为空！", "ExView");
				}
			});
			$$("#login-cancle").on("click", function() {

			});					
		},
		typelistext: {
			"index": {
				title: "首页",
				imgurl: getbaiduimg("d3304434970a304eeae53a66d7c8a786c8175c12")
			},
			"topfive": {
				title: "五星推荐",
				imgurl: getbaiduimg("e65387c379310a5540bf2322b04543a983261036")
			}
		},
		typelist: {
			"doujinshi": {
				title: "同人",
				imgurl: getbaiduimg("1b309b19ebc4b745b51c4ac0c8fc1e17888215c5")
			},
			"manga": {
				title: "漫画",
				imgurl: getbaiduimg("61aa13c79f3df8dc6b797347ca11728b46102801")
			},
			"artistcg": {
				title: "画家CG",
				imgurl: getbaiduimg("574621f790529822470fc615d0ca7bcb0b46d489")
			},
			"gamecg": {
				title: "游戏CG",
				imgurl: getbaiduimg("9be791014a90f6038e4160913e12b31bb251eddd")
			},
			"western": {
				title: "西方风格",
				imgurl: getbaiduimg("6a897ce736d12f2ec04351b648c2d56284356803")
			},
			"non-h": {
				title: "全年龄",
				imgurl: getbaiduimg("8137b022720e0cf3e088b12d0d46f21fbf09aa4a")
			},
			"imageset": {
				title: "图集",
				imgurl: getbaiduimg("3448fc2a2834349b48489153ceea15ce37d3be7b")
			},
			"cosplay": {
				title: "角色扮演",
				imgurl: getbaiduimg("20c8e3ef76094b36c7a8e53ba4cc7cd98c109d97")
			},
			"asianporn": {
				title: "亚洲艺术",
				imgurl: getbaiduimg("574621f790529822462bc715d0ca7bcb0b46d4b5")
			},
			"misc": {
				title: "杂项",
				imgurl: getbaiduimg("574621f7905298224624c715d0ca7bcb0b46d4b2")
			}
		},
		pagerule: /<td\s*class="itdc"><a\s*href="(.*?)"><img\s*src="(.*?)"\s*alt="(.*?)"\s*class="ic"\s*\/><\/a><\/td><td\s*class="itd"\s*style="white-space:nowrap">(.*?)<\/td><td\s*class="itd"\s*onmouseover="preload_pane_image_delayed\((.*?)\)"\s*onmouseout="preload_pane_image_cancel\(\)"><div\s*style="position:relative"><div\s*class="it2"\s*id="i(.*?)"\s*style="border:(.*?)(~|\/)t\/(.*?).jpg(~|")(.*?)<\/div><div\s*class="it3">(.*?)<\/div><div\s*class="it5"><a\s*href="(.*?)"\s*onmouseover="show_image_pane\((.*?)\)"\s*onmouseout="hide_image_pane\((.*?)\)">(.*?)<\/a><\/div><div\s*class="it4"><div\s*class="ir\s*it4r"\s*style="background-position:(.*?)"><\/div>\s*<\/div><\/div><\/td><td\s*class="itu"><div><a\s*href="(.*?)">(.*?)<\/a><\/div><\/td>/g,
		pagefind: "$2" + "{{separator}}" + "$3" + "{{separator}}" + "$4" + "{{separator}}" + "$6" + "{{separator}}" + "$9" + "{{separator}}" + "$13" + "{{separator}}" + "$16" + "{{separator}}" + "$19" + "{{separator}}" + "$17",
		pagecountrule: />Showing\s*(\d+)\s*-\s*(\d+)\s*of\s*([\d,]+)\s*(images|)<\/p>/g,
		pagecountfind: "$1" + "{{separator}}" + "$2" + "{{separator}}" + "$3",
		pagedeal: function(rr, args) {
			args = args || {};
			if (typeof(rr) == "string") rr = rr.split("{{separator}}");
			var pid = rr[5].replace(pluginfo(args.plugin).apihost + "g/", "").replace("/", "_").replace("/", "");
			var title = rr[6];
			var start = rr[8].split("px");
			var starthalf = (parseInt(start[1]) == -21) ? true : false;
			var startcount = (80 + parseInt(start[0])) / 16 - (starthalf ? 0.5 : 0);
			start = "";
			for (var i = 0; i < parseInt(startcount); i++) {
				start += "★";
			}
			start += (starthalf ? "☆" : "");
			var img = pluginfo(args.plugin).apihost + "t/" + rr[4] + ".jpg";
			//if(pluginfo(args.plugin).nativeres){
				img=getimgload(img,args.plugin,{cachepath:pluginfo(args.plugin).covercachepath,cachetime:0});
			//}
			/*
			var getimgcachesuccessfn = function(name, fullPath, entry, pid, imgurl) {
					try {
						var pagedom = $$(".card_" + pid).find("img");
						$$(pagedom).attr("data-src", imgurl);
						$$(pagedom).attr("src", fullPath);
						$$(pagedom).removeClass("preload").addClass("loaded");
						//alert(fullPath);
					} catch (e) {}

					//alert(pid);
					//var savecachename=hex_md5(imgurl);
					try {
						var pagedom = $$(".card_" + pid).find(".card-header");
						$$(pagedom).attr("data-source-src", imgurl);
						$$(pagedom).attr("data-background-src", "url(" + fullPath + "), url(img/loading.png)");
						$$(pagedom).attr("data-now-src", fullPath);
						$$(pagedom).removeClass("preload").addClass("loaded");
						$$(pagedom).css("background-image", "url(" + fullPath + "), url(img/loading.png)");
					} catch (e) {}

					//alert($$(pagedom).css("background-image"));
				}
			var getimgcacheerrorfn = function(error) {
					//myApp.alert(error);
					console.log(error);
				}
			pluginfo(args.plugin).nativeres && ExView.modules.getimgcache(img, function(name, fullPath, entry) {
				getimgcachesuccessfn && getimgcachesuccessfn(name, fullPath, entry, pid, img);
			}, getimgcacheerrorfn, null, pluginfo(args.plugin).covercachepath);
			*/
			
			try {
				var content = '【' + plugfns(args.plugin).typelist[rr[1]]["title"] + '】' + "By " + rr[7];
			} catch (e) {
				var content = "By " + rr[7];
			}
			if (args.multupdate) {
				args.multupdate(obj_contact(args, {
					pid: pid,
					img: img,
					title: title,
					content: content
				}));
				return false;
			}
			if (args.multhot) {
				args.multhot(obj_contact(args, {
					pid: pid,
					img: img,
					title: title,
					content: content
				}));
				return false;
			}
			if (args.multsearch) {
				args.multsearch(obj_contact(args, {
					pid: pid,
					img: img,
					title: title,
					content: content
				}));
				return false;
			}
			addcardlist({
				pid: pid,
				title: title,
				//name: '【' + start + startcount + '星】' + title,
				img: img,
				content: content+'<br>【更新日期】'+rr[2],
				stitle: start ,
				comment: 1,
				preview: 1,
				extrabutton: ''
			});
		}
	}
})